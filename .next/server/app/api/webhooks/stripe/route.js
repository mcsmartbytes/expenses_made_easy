"use strict";(()=>{var e={};e.id=798,e.ids=[798],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},2361:e=>{e.exports=require("events")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},3837:e=>{e.exports=require("util")},9796:e=>{e.exports=require("zlib")},3504:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>S,patchFetch:()=>R,requestAsyncStorage:()=>g,routeModule:()=>w,serverHooks:()=>v,staticGenerationAsyncStorage:()=>E});var s={};t.r(s),t.d(s,{POST:()=>l});var o=t(9303),i=t(8716),a=t(670),n=t(7070),u=t(8472),c=t(1657);let p=new u.Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"}),d=(0,c.eI)("https://vckynnyputrvwjhosryl.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);async function l(e){let r;let t=await e.text(),s=e.headers.get("stripe-signature");try{r=p.webhooks.constructEvent(t,s,process.env.STRIPE_WEBHOOK_SECRET)}catch(e){return console.error("Webhook error:",e.message),n.NextResponse.json({error:"Webhook Error"},{status:400})}console.log("Webhook received:",r.type);try{switch(r.type){case"checkout.session.completed":{let e=r.data.object;await _(e);break}case"customer.subscription.created":case"customer.subscription.updated":{let e=r.data.object;await b(e);break}case"customer.subscription.deleted":{let e=r.data.object;await f(e);break}case"invoice.payment_failed":{let e=r.data.object;await m(e);break}default:console.log(`Unhandled event type: ${r.type}`)}}catch(e){return console.error("Error processing webhook:",e),n.NextResponse.json({error:"Webhook handler error"},{status:500})}return n.NextResponse.json({received:!0})}async function _(e){let r=e.metadata?.user_id,t=e.customer,s=e.subscription;if(!r){console.error("No user_id in session metadata");return}let o=await p.subscriptions.retrieve(s),i=h(o.items.data[0]?.price.id),{error:a}=await d.from("user_profiles").upsert({user_id:r,stripe_customer_id:t,stripe_subscription_id:s,subscription_plan:i,subscription_status:"trialing"===o.status?"trialing":"active",subscription_start_date:new Date(1e3*o.current_period_start).toISOString(),subscription_end_date:new Date(1e3*o.current_period_end).toISOString(),trial_start_date:o.trial_start?new Date(1e3*o.trial_start).toISOString():null,trial_end_date:o.trial_end?new Date(1e3*o.trial_end).toISOString():null},{onConflict:"user_id"});if(a)throw console.error("Error updating user profile:",a),a;console.log(`User ${r} subscribed to ${i} plan`)}async function b(e){let r=e.customer,t=h(e.items.data[0]?.price.id),{data:s,error:o}=await d.from("user_profiles").select("user_id").eq("stripe_customer_id",r).single();if(o||!s){console.error("User not found for customer:",r);return}let i=function(e){switch(e){case"active":return"active";case"trialing":return"trialing";case"past_due":return"past_due";case"canceled":case"unpaid":case"incomplete_expired":return"canceled";default:return"inactive"}}(e.status),{error:a}=await d.from("user_profiles").update({subscription_plan:t,subscription_status:i,subscription_start_date:new Date(1e3*e.current_period_start).toISOString(),subscription_end_date:new Date(1e3*e.current_period_end).toISOString()}).eq("user_id",s.user_id);if(a)throw console.error("Error updating subscription:",a),a;console.log(`Subscription updated for user ${s.user_id}: ${t} (${i})`)}async function f(e){let r=e.customer,{data:t}=await d.from("user_profiles").select("user_id").eq("stripe_customer_id",r).single();if(!t)return;let{error:s}=await d.from("user_profiles").update({subscription_status:"canceled",subscription_plan:"free"}).eq("user_id",t.user_id);if(s)throw console.error("Error canceling subscription:",s),s;console.log(`Subscription canceled for user ${t.user_id}`)}async function m(e){let r=e.customer,{data:t}=await d.from("user_profiles").select("user_id").eq("stripe_customer_id",r).single();if(!t)return;let{error:s}=await d.from("user_profiles").update({subscription_status:"past_due"}).eq("user_id",t.user_id);if(s)throw console.error("Error updating payment status:",s),s;console.log(`Payment failed for user ${t.user_id}`)}function h(e){let r=[process.env.STRIPE_PREMIUM_MONTHLY_PRICE_ID,process.env.STRIPE_PREMIUM_YEARLY_PRICE_ID],t=[process.env.STRIPE_PRO_MONTHLY_PRICE_ID,process.env.STRIPE_PRO_YEARLY_PRICE_ID];return r.includes(e)?"premium":t.includes(e)?"pro":"free"}let w=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/home/mcsmart/projects/active/expenses_made_easy/app/api/webhooks/stripe/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:E,serverHooks:v}=w,S="/api/webhooks/stripe/route";function R(){return(0,a.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:E})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,972,657,472],()=>t(3504));module.exports=s})();